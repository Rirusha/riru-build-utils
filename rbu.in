#!/usr/bin/env python3
'''
Copyright (C) 2024 Vladimir Vaskov

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

SPDX-License-Identifier: GPL-3.0-or-later
'''


from subprocess import Popen
import sys

from rbu.constants import Constants
from rbu.creator import Creator
from rbu.tester import Tester
from rbu.updater import Updater


def print_help():
    print ('Usage:')
    print ('\trbu create <language> <project type>')
    print ('\trbu update <git url or alias name> [<tag>] [<task-id-root>] [--test]')
    print ('\trbu test [<working dir>]')

def main():    
    argv = sys.argv.copy()

    Constants.PKGDATADIR = "@pkgdatadir@"

    argv.pop(0)
    
    if len(argv) == 0:
        print('No command. Available: create, update, test')
        print_help()
        return

    command = argv.pop(0)

    match command:
        case 'create':
            create(argv)
        case 'update':
            update(argv)
        case 'test':
            test(argv)
        case _:
            print (f'Unknown command: {command}')
            return

def create (argv:list[str]):
    language:str = None
    project_type:str = None
    
    if len(argv) > 0:
        language = argv.pop(0)

        if len(argv) > 0:
            project_type = argv.pop(0)

            if len(argv) > 0:
                print ('Too many args.')
                return

    if language is None or project_type is None:
        print (f"Not enough args.")
        return

    Creator(language, project_type).create()

def update (argv:list[str]):
    name:str = ""
    tag:str|None = None
    task_root:str|None = None
    test:bool = False
    
    for arg in argv:
        if arg == '--test':
            test = True
            argv.remove(arg)

    if len(argv) > 0:
        name = argv.pop(0)

        if len(argv) > 0:
            tag = argv.pop(0)

            if len(argv) > 0:
                task_root = argv.pop(0)

                if len(argv) > 0:
                    print ('Too many args.')
                    return
    else:
        print (f"Not enough args.")
        return

    Updater(name, tag, task_root, test).update()

def test (argv:list[str]):
    working_dir:str|None = None

    if len(argv) > 0:
        working_dir = argv.pop(0)

        if len(argv) > 0:
            print ('Too many args.')
            return

    Tester(working_dir).test()


if __name__ == '__main__':
    main()
